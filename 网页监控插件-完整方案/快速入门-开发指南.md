# å¿«é€Ÿå…¥é—¨ - å¼€å‘ç½‘é¡µæ›´æ–°æ¨é€æœºå™¨äººæ’ä»¶

## ğŸ“‹ å‰ç½®å‡†å¤‡

### 1. ç¯å¢ƒè¦æ±‚
- Python 3.8+
- Git
- AstrBot v4.10+
- VS Code æˆ–å…¶ä»–ä»£ç ç¼–è¾‘å™¨

### 2. å¼€å‘è€…æ³¨å†Œ
- GitHub è´¦å·
- åŠ å…¥ AstrBot å¼€å‘è€…ç¤¾åŒº (QQç¾¤: 975206796)

---

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ5åˆ†é’Ÿï¼‰

### æ­¥éª¤1: åˆ›å»ºæ’ä»¶ä»“åº“

1. æ‰“å¼€ [helloworld æ¨¡æ¿](https://github.com/Soulter/helloworld)
2. ç‚¹å‡» "Use this template" â†’ "Create new repository"
3. å¡«å†™ä»“åº“ä¿¡æ¯ï¼š
   - Repository name: `astrbot_plugin_webupdater`
   - Description: "Web page update monitor for AstrBot"
   - å‹¾é€‰ "Public"ï¼ˆå»ºè®®ï¼‰
4. ç‚¹å‡» "Create repository"

### æ­¥éª¤2: å…‹éš†åˆ°æœ¬åœ°

```bash
# è¿›å…¥ AstrBot æ’ä»¶ç›®å½•
cd AstrBot/data/plugins

# å…‹éš†æ–°å»ºçš„æ’ä»¶ä»“åº“
git clone https://github.com/YOUR_USERNAME/astrbot_plugin_webupdater
cd astrbot_plugin_webupdater
```

### æ­¥éª¤3: é…ç½®æ’ä»¶å…ƒæ•°æ®

ç¼–è¾‘ `metadata.yaml`ï¼š

```yaml
name: webupdater
version: 1.0.0
display_name: ç½‘é¡µæ›´æ–°ç›‘æ§
description: è‡ªåŠ¨ç›‘æ§ç½‘é¡µå†…å®¹å˜åŒ–å¹¶æ¨é€æ›´æ–°é€šçŸ¥
author: YourName
homepage: https://github.com/yourname/astrbot_plugin_webupdater
repository: https://github.com/yourname/astrbot_plugin_webupdater
tags:
  - monitor
  - notification
  - web
```

### æ­¥éª¤4: å®ç°æ ¸å¿ƒä»£ç 

æ›¿æ¢ `main.py`ï¼Œå¤åˆ¶ä¸Šæ–‡çš„ `æ’ä»¶å®ç°ç¤ºä¾‹_main.py` å†…å®¹

### æ­¥éª¤5: é…ç½®ä¾èµ–

ç¼–è¾‘ `requirements.txt`ï¼š

```
astrbot>=4.10.0
httpx>=0.24.0
```

### æ­¥éª¤6: æµ‹è¯•æ’ä»¶

```bash
# å¯åŠ¨ AstrBot
python main.py

# åœ¨èŠå¤©ç•Œé¢æµ‹è¯•å‘½ä»¤
/webupdater add https://github.com/releases 3600
/webupdater list
```

---

## ğŸ—ï¸ é¡¹ç›®ç»“æ„è¯¦è§£

```
astrbot_plugin_webupdater/
â”‚
â”œâ”€â”€ main.py                    # æ ¸å¿ƒæ’ä»¶ä»£ç 
â”‚   â”œâ”€â”€ WebUpdateTask         # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ ä»»åŠ¡åºåˆ—åŒ–/ååºåˆ—åŒ–
â”‚   â”‚   â”œâ”€â”€ å“ˆå¸Œè®¡ç®—
â”‚   â”‚   â””â”€â”€ çŠ¶æ€ç®¡ç†
â”‚   â”‚
â”‚   â””â”€â”€ WebUpdaterPlugin      # æ’ä»¶ä¸»ç±»
â”‚       â”œâ”€â”€ ç”Ÿå‘½å‘¨æœŸæ–¹æ³•(on_bot_loaded)
â”‚       â”œâ”€â”€ æŒ‡ä»¤å¤„ç†(add/remove/listç­‰)
â”‚       â”œâ”€â”€ ç›‘æ§é€»è¾‘(å¼‚æ­¥å¾ªç¯)
â”‚       â”œâ”€â”€ å†…å®¹æ£€æŸ¥(fetch/hash/detect)
â”‚       â””â”€â”€ æ¨é€é€šçŸ¥(send_update)
â”‚
â”œâ”€â”€ metadata.yaml              # æ’ä»¶å…ƒæ•°æ®
â”œâ”€â”€ requirements.txt           # Pythonä¾èµ–
â”œâ”€â”€ README.md                  # ä½¿ç”¨è¯´æ˜
â”œâ”€â”€ logo.png                   # æ’ä»¶å›¾æ ‡ (256x256)
â””â”€â”€ .gitignore                # Gitå¿½ç•¥è§„åˆ™
```

---

## ğŸ’» ä»£ç å®ç°è¦ç‚¹

### æ ¸å¿ƒ1: å¼‚æ­¥ç›‘æ§æ¶æ„

```python
@filter.on_astrbot_loaded()
async def on_bot_loaded(self):
    # åœ¨æœºå™¨äººåŠ è½½æ—¶å¯åŠ¨æ‰€æœ‰ç›‘æ§ä»»åŠ¡
    self.load_tasks()
    for task_id, task in self.tasks.items():
        if task.enabled:
            await self.start_monitoring(task_id)

async def start_monitoring(self, task_id: str):
    # ä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºç‹¬ç«‹çš„å¼‚æ­¥åç¨‹
    task = asyncio.create_task(self._monitoring_loop(task_id))
    self.running_tasks[task_id] = task

async def _monitoring_loop(self, task_id: str):
    # åœ¨åå°å¾ªç¯è¿è¡Œï¼Œå®šæœŸæ£€æŸ¥ç½‘é¡µ
    while True:
        try:
            content = await self.check_update(task)
            if content:
                await self._send_update_notification(task, content)
            await asyncio.sleep(task.interval)
        except Exception as e:
            self.logger.error(f"å¼‚å¸¸: {e}")
```

### æ ¸å¿ƒ2: æŒ‡ä»¤å¤„ç†

```python
@filter.command_group("webupdater")
def webupdater_group(self):
    pass

@webupdater_group.command("add")
async def cmd_add_monitor(self, event: AstrMessageEvent, url: str, interval: int = 300):
    # 1. éªŒè¯è¾“å…¥
    if not self._validate_url(url):
        yield event.plain_result("âŒ æ— æ•ˆçš„URL")
        return
    
    # 2. åˆ›å»ºä»»åŠ¡å¯¹è±¡
    task = WebUpdateTask(url=url, interval=interval)
    
    # 3. ä¿å­˜åˆ°å­˜å‚¨
    self.tasks[task.id] = task
    self.save_tasks()
    
    # 4. å¯åŠ¨ç›‘æ§
    await self.start_monitoring(task.id)
    
    # 5. è¿”å›ç»“æœ
    yield event.plain_result(f"âœ… å·²æ·»åŠ ä»»åŠ¡ {task.id}")
```

### æ ¸å¿ƒ3: å†…å®¹æ£€æŸ¥

```python
async def check_update(self, task: WebUpdateTask) -> Optional[str]:
    try:
        # 1. è·å–ç½‘é¡µå†…å®¹
        content = await self._fetch_url(task.url)
        if not content:
            return None
        
        # 2. è®¡ç®—å“ˆå¸Œå€¼
        content_hash = self._calculate_hash(content)
        
        # 3. å¯¹æ¯”æ˜¯å¦æœ‰æ›´æ–°
        if task.last_hash and task.last_hash == content_hash:
            return None  # æ— æ›´æ–°
        
        # 4. æ›´æ–°è®°å½•
        task.last_hash = content_hash
        self.save_tasks()
        
        # 5. è¿”å›æ‘˜è¦
        return self._extract_content_summary(content)
    except Exception as e:
        self.logger.error(f"æ£€æŸ¥æ›´æ–°å¤±è´¥: {e}")
        return None
```

### æ ¸å¿ƒ4: ä¸»åŠ¨æ¨é€

```python
async def _send_update_notification(self, task: WebUpdateTask, content: str):
    try:
        # æ„å»ºæ¶ˆæ¯é“¾
        chain = [
            Comp.Plain(
                f"ğŸ“¢ æ£€æµ‹åˆ°ç½‘é¡µæ›´æ–°ï¼\n"
                f"ğŸ”— URL: {task.url}\n"
                f"{content}"
            )
        ]
        
        # ä¸»åŠ¨æ¨é€åˆ°æŒ‡å®šä¼šè¯
        await self.context.send_message(
            task.unified_msg_origin,
            MessageChain(chain)
        )
    except Exception as e:
        self.logger.error(f"æ¨é€å¤±è´¥: {e}")
```

---

## ğŸ“ å…³é”®APIä½¿ç”¨

### 1. æ¥æ”¶æ¶ˆæ¯äº‹ä»¶

```python
from astrbot.api.event import filter, AstrMessageEvent

@filter.command("add")
async def cmd_add(self, event: AstrMessageEvent, url: str):
    # event åŒ…å«ï¼š
    # - event.message_str: æ¶ˆæ¯æ–‡æœ¬
    # - event.get_sender_name(): å‘é€è€…æ˜µç§°
    # - event.unified_msg_origin: ä¼šè¯æ ‡è¯†ï¼ˆç”¨äºæ¨é€ï¼‰
    
    yield event.plain_result(f"å·²æ¥æ”¶: {url}")
```

### 2. å‘é€è¢«åŠ¨æ¶ˆæ¯ï¼ˆå“åº”å¼ï¼‰

```python
# æ–¹å¼1: çº¯æ–‡æœ¬
yield event.plain_result("Hello!")

# æ–¹å¼2: æ¶ˆæ¯é“¾ï¼ˆæ”¯æŒå¯Œåª’ä½“ï¼‰
yield event.chain_result([
    Comp.Plain("æ–‡æœ¬å†…å®¹"),
    Comp.Image.fromURL("https://example.com/image.jpg")
])
```

### 3. å‘é€ä¸»åŠ¨æ¶ˆæ¯ï¼ˆæ¨é€å¼ï¼‰

```python
# ä¿å­˜ unified_msg_origin
umo = event.unified_msg_origin

# åœ¨åç»­ä»»ä½•æ—¶é—´æ¨é€æ¶ˆæ¯
message_chain = MessageChain([Comp.Plain("æ¨é€å†…å®¹")])
await self.context.send_message(umo, message_chain)
```

### 4. å¼‚æ­¥HTTPè¯·æ±‚

```python
import httpx

async def fetch_url(self, url: str):
    try:
        async with httpx.AsyncClient() as client:
            response = await client.get(
                url,
                timeout=10,
                follow_redirects=True
            )
            return response.text if response.status_code == 200 else None
    except Exception as e:
        self.logger.error(f"è¯·æ±‚å¤±è´¥: {e}")
        return None
```

### 5. æ•°æ®æŒä¹…åŒ–

```python
import json
import os

def save_tasks(self):
    # åºåˆ—åŒ–ä»»åŠ¡
    data = {
        "tasks": [task.to_dict() for task in self.tasks.values()]
    }
    
    # ä¿å­˜åˆ° data ç›®å½•
    os.makedirs(self.storage_dir, exist_ok=True)
    with open(self.tasks_file, 'w') as f:
        json.dump(data, f, indent=2)

def load_tasks(self):
    # ä»æ–‡ä»¶åŠ è½½
    with open(self.tasks_file, 'r') as f:
        data = json.load(f)
    
    self.tasks = {}
    for task_data in data.get("tasks", []):
        task = WebUpdateTask.from_dict(task_data)
        self.tasks[task.id] = task
```

---

## ğŸ§ª æµ‹è¯•ä¸è°ƒè¯•

### æµ‹è¯•1: éªŒè¯URLå¤„ç†

```python
def test_validate_url():
    assert WebUpdaterPlugin._validate_url("https://example.com") == True
    assert WebUpdaterPlugin._validate_url("http://example.com") == True
    assert WebUpdaterPlugin._validate_url("example.com") == False
    assert WebUpdaterPlugin._validate_url("ftp://example.com") == False
```

### æµ‹è¯•2: éªŒè¯å“ˆå¸Œè®¡ç®—

```python
def test_hash_calculation():
    content = "Hello World"
    hash1 = WebUpdaterPlugin._calculate_hash(content)
    hash2 = WebUpdaterPlugin._calculate_hash(content)
    assert hash1 == hash2  # åŒæ ·å†…å®¹å“ˆå¸Œç›¸åŒ
    
    hash3 = WebUpdaterPlugin._calculate_hash("Hello World!")
    assert hash1 != hash3  # ä¸åŒå†…å®¹å“ˆå¸Œä¸åŒ
```

### æµ‹è¯•3: å®Œæ•´æµç¨‹æµ‹è¯•

```bash
# 1. å¯åŠ¨AstrBotå¹¶åŠ è½½æ’ä»¶
python main.py

# 2. åœ¨èŠå¤©ä¸­æµ‹è¯•
/webupdater add https://httpbin.org/delay/1 60

# 3. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤ç›‘æ§å¯åŠ¨
# [INFO] å·²å¯åŠ¨ç›‘æ§ä»»åŠ¡: abc12345

# 4. éªŒè¯ data/webupdater/tasks.json æ–‡ä»¶è¢«åˆ›å»º

# 5. ç­‰å¾…60ç§’åéªŒè¯æ˜¯å¦èƒ½æ£€æŸ¥åˆ°æ›´æ–°
/webupdater list

# 6. ä½¿ç”¨ check å‘½ä»¤æ‰‹åŠ¨è§¦å‘
/webupdater check abc12345
```

---

## ğŸ› å¸¸è§é”™è¯¯åŠè§£å†³

### é”™è¯¯1: ImportError: No module named 'httpx'

**åŸå› :** ç¼ºå°‘ä¾èµ–

**è§£å†³:**
```bash
pip install -r requirements.txt
```

### é”™è¯¯2: AttributeError: 'Context' has no attribute 'send_message'

**åŸå› :** APIè°ƒç”¨é”™è¯¯

**è§£å†³:**
```python
# é”™è¯¯: self.context.send_message(...)
# æ­£ç¡®:
await self.context.send_message(unified_msg_origin, message_chain)
```

### é”™è¯¯3: ä»»åŠ¡å¯åŠ¨åç«‹å³åœæ­¢

**å¯èƒ½åŸå› :**
1. å¼‚å¸¸æœªè¢«æ•è·
2. ç½‘ç»œè¯·æ±‚è¶…æ—¶
3. ç£ç›˜ç©ºé—´ä¸è¶³

**è°ƒè¯•æ–¹æ³•:**
```python
# åœ¨ _monitoring_loop ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—
self.logger.debug(f"[{task_id}] å¼€å§‹æ£€æŸ¥...")
self.logger.debug(f"[{task_id}] è·å–å†…å®¹æˆåŠŸ")
self.logger.debug(f"[{task_id}] å“ˆå¸Œ: {content_hash}")
```

---

## ğŸ“¦ å‘å¸ƒæ’ä»¶

### 1. å‡†å¤‡å‘å¸ƒ

```bash
# ç¡®ä¿æ‰€æœ‰ä»£ç å·²æäº¤
git add .
git commit -m "feat: Initial release v1.0.0"
git push origin main

# æ·»åŠ ç‰ˆæœ¬æ ‡ç­¾
git tag -a v1.0.0 -m "Version 1.0.0"
git push origin v1.0.0
```

### 2. æäº¤åˆ°æ’ä»¶å¸‚åœº

- è®¿é—® [AstrBotæ’ä»¶å¸‚åœº](https://astrbot.app/plugins)
- æŒ‰ç…§æŒ‡å¼•æäº¤æ‚¨çš„æ’ä»¶ä»“åº“
- ç­‰å¾…å®¡æ ¸

### 3. å‘å¸ƒåç»´æŠ¤

- å®šæœŸæ›´æ–°ä¾èµ–
- ä¿®å¤ç”¨æˆ·åé¦ˆçš„é—®é¢˜
- æ·»åŠ æ–°åŠŸèƒ½å¹¶æ›´æ–°ç‰ˆæœ¬å·

---

## ğŸ“š å»¶ä¼¸å­¦ä¹ 

### æ ¸å¿ƒæ¦‚å¿µ
- **å¼‚æ­¥ç¼–ç¨‹**: `asyncio`, `await`, `async def`
- **æ•°æ®æŒä¹…åŒ–**: JSONåºåˆ—åŒ–/ååºåˆ—åŒ–
- **å“ˆå¸Œç®—æ³•**: SHA256å†…å®¹æŒ‡çº¹
- **ç½‘ç»œè¯·æ±‚**: httpxå¼‚æ­¥HTTPå®¢æˆ·ç«¯

### æ¨èèµ„æº
- [AstrBotå®˜æ–¹æ–‡æ¡£](https://docs.astrbot.app/)
- [Pythonå¼‚æ­¥ç¼–ç¨‹](https://docs.python.org/zh-cn/3/library/asyncio.html)
- [httpxæ–‡æ¡£](https://www.python-httpx.org/)
- [GitHub Copilotè¾…åŠ©å¼€å‘](https://github.com/features/copilot)

### è¿›é˜¶åŠŸèƒ½å¼€å‘
1. **å†…å®¹è§£æ**: ä½¿ç”¨BeautifulSoupæå–ç‰¹å®šå…ƒç´ 
2. **å·®å¼‚å¯¹æ¯”**: ä½¿ç”¨difflibæ˜¾ç¤ºä¿®æ”¹å†…å®¹
3. **å¤šå¹³å°é€‚é…**: æ”¯æŒé‚®ä»¶ã€Telegramç­‰æ¨é€
4. **æ•°æ®åº“é›†æˆ**: ä½¿ç”¨SQLiteå­˜å‚¨å†å²è®°å½•

---

## âœ¨ æ€»ç»“

æ‚¨å·²å­¦ä¼šå¦‚ä½•å¼€å‘ä¸€ä¸ªå®Œæ•´çš„AstrBotæ’ä»¶ï¼è¿™ä¸ªç½‘é¡µç›‘æ§æ’ä»¶å±•ç¤ºäº†ï¼š

âœ… **å¼‚æ­¥æ¶æ„** - é«˜æ•ˆå¤„ç†å¤šä»»åŠ¡  
âœ… **äº‹ä»¶ç³»ç»Ÿ** - å“åº”å¼å’Œä¸»åŠ¨å¼æ¶ˆæ¯  
âœ… **æ•°æ®æŒä¹…åŒ–** - ä»»åŠ¡é…ç½®ä¿å­˜æ¢å¤  
âœ… **é”™è¯¯å¤„ç†** - è®©æ’ä»¶æ›´ç¨³å®š  
âœ… **ç”¨æˆ·äº¤äº’** - çµæ´»çš„å‘½ä»¤ç³»ç»Ÿ  

ç»§ç»­æ”¹è¿›å¹¶åˆ†äº«æ‚¨çš„æ’ä»¶ï¼Œä¸ºAstrBotç”Ÿæ€åšå‡ºè´¡çŒ®ï¼ğŸš€

---

**éœ€è¦å¸®åŠ©?** 
- ğŸ’¬ åŠ å…¥å¼€å‘è€…ç¾¤: QQ 975206796
- ğŸ“– æŸ¥çœ‹å®Œæ•´æ–‡æ¡£: https://docs.astrbot.app/
- ğŸ› æäº¤é—®é¢˜: GitHub Issues
