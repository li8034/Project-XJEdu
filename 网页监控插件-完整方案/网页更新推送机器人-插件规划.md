# 网页更新推送机器人 - AstrBot 插件规划文档

## 项目概述

基于 AstrBot 开发的自动网页监控插件，用于：
- 定期监控指定网页的内容变化
- 检测到更新时自动向指定会话发送推送消息
- 支持多个网页同时监控
- 提供灵活的配置管理

---

## 核心功能设计

### 1. **监控任务管理**
- **添加监控任务**: `/webupdater add <url> <interval>` 添加新的网页监控任务
- **删除监控任务**: `/webupdater remove <task_id>` 删除监控任务
- **查看监控列表**: `/webupdater list` 查看所有活跃监控任务
- **启用/禁用任务**: `/webupdater enable/disable <task_id>` 控制任务状态

### 2. **后台监控系统**
- 使用异步定时任务（`asyncio.Task`）在后台运行
- 在 `on_astrbot_loaded` 钩子启动所有已保存的监控任务
- 定期轮询检查网页内容（支持定制检查间隔，如5分钟、1小时等）
- 智能比对算法检测实际更新（避免重复推送相同内容）

### 3. **更新检测与推送**
- 使用 `httpx` 或 `aiohttp` 异步获取网页内容
- 获取网页标题、主体内容、更新时间等关键信息
- 使用内容哈希或版本号对比检测更新
- 更新时立即通过 `context.send_message()` 主动推送到目标会话

### 4. **配置与存储**
- **metadata.yaml**: 插件基本信息和依赖配置
- **plugin.yaml**: 插件配置文件（用户可配置全局设置）
- **持久化存储**: 将监控任务保存到 `data` 目录，重启后自动恢复

---

## 项目结构

```
astrbot_plugin_webupdater/
├── main.py                          # 插件主文件
├── metadata.yaml                    # 插件元数据
├── plugin.yaml                      # 插件配置模板
├── requirements.txt                 # 依赖列表
├── logo.png                         # 插件logo（256x256）
├── README.md                        # 使用说明
└── .gitignore                       # Git忽略文件
```

---

## 详细设计方案

### A. 插件主文件 (main.py) 结构

#### 1. 导入模块
```python
from astrbot.api.star import Context, Star, register
from astrbot.api.event import filter, AstrMessageEvent
import astrbot.api.message_components as Comp
from astrbot.api.message import MessageChain

import asyncio
import httpx
import hashlib
import json
import os
from datetime import datetime
from typing import Dict, Optional, List
```

#### 2. 核心类设计

**WebUpdateTask 类** - 单个监控任务
```python
class WebUpdateTask:
    - task_id: str              # 任务ID
    - url: str                  # 监控网址
    - interval: int             # 检查间隔（秒）
    - enabled: bool             # 是否启用
    - last_hash: str            # 上次内容的哈希值
    - last_check_time: int      # 最后检查时间
    - asyncio_task: Task        # 异步任务对象
    - unified_msg_origin: str   # 推送目标会话
    
    methods:
    - to_dict()                 # 序列化
    - from_dict()               # 反序列化
    - calculate_hash()          # 计算内容哈希
```

**WebUpdaterPlugin 类** - 插件主类
```python
@register("webupdater", "You", "网页自动更新监控与推送插件", "1.0.0")
class WebUpdaterPlugin(Star):
    - tasks: Dict[str, WebUpdateTask]      # 所有监控任务
    - running_tasks: Dict[str, Task]       # 运行中的异步任务
    - storage_path: str                    # 数据存储路径
    
    methods:
    - __init__()                           # 初始化
    - load_tasks()                         # 从存储加载任务
    - save_tasks()                         # 保存任务到存储
    - start_monitoring(task_id)            # 启动单个监控
    - stop_monitoring(task_id)             # 停止单个监控
    - check_update(task)                   # 检查单个任务更新
    - send_update_notification()           # 发送更新推送
```

#### 3. 指令实现

```python
# 主指令组
@filter.command_group("webupdater")
def webupdater():
    pass

# 子指令1: 添加监控
@webupdater.command("add")
async def add_monitor(self, event: AstrMessageEvent, url: str, interval: int = 300):
    """
    参数:
    - url: 要监控的网页URL
    - interval: 检查间隔（默认300秒）
    """
    # 1. 验证URL合法性
    # 2. 创建WebUpdateTask对象
    # 3. 保存到存储
    # 4. 启动监控异步任务
    # 5. 返回成功消息

# 子指令2: 删除监控
@webupdater.command("remove")
async def remove_monitor(self, event: AstrMessageEvent, task_id: str):
    """删除指定ID的监控任务"""
    # 1. 查找任务
    # 2. 停止异步任务
    # 3. 从存储删除
    # 4. 返回确认消息

# 子指令3: 查看监控列表
@webupdater.command("list")
async def list_monitors(self, event: AstrMessageEvent):
    """显示所有监控任务的状态"""
    # 1. 遍历所有任务
    # 2. 格式化显示（任务ID、URL、状态、下次检查时间）
    # 3. 返回格式化的消息链

# 子指令4: 启用监控
@webupdater.command("enable")
async def enable_monitor(self, event: AstrMessageEvent, task_id: str):
    """启用指定任务"""
    # 1. 找到任务
    # 2. 标记为启用
    # 3. 启动异步监控
    # 4. 保存配置

# 子指令5: 禁用监控
@webupdater.command("disable")
async def disable_monitor(self, event: AstrMessageEvent, task_id: str):
    """禁用指定任务"""
    # 1. 找到任务
    # 2. 标记为禁用
    # 3. 停止异步监控
    # 4. 保存配置

# 子指令6: 手动检查
@webupdater.command("check")
async def check_now(self, event: AstrMessageEvent, task_id: str):
    """立即检查指定任务"""
    # 1. 手动触发一次检查
    # 2. 返回检查结果
```

#### 4. 事件钩子实现

```python
@filter.on_astrbot_loaded()
async def on_astrbot_loaded(self):
    """
    AstrBot启动时执行：
    1. 加载所有已保存的监控任务
    2. 启动所有启用状态的异步监控任务
    """

@filter.after_message_sent()
async def after_message_sent(self, event: AstrMessageEvent):
    """
    消息发送后执行：
    1. 记录推送时间日志
    """
```

#### 5. 异步监控逻辑

```python
async def monitoring_loop(self, task: WebUpdateTask):
    """
    后台监控循环（运行在异步任务中）
    
    流程:
    1. 当任务启用时，每隔interval秒检查一次
    2. 调用check_update()检查更新
    3. 如果有更新，调用send_update_notification()推送
    4. 更新last_check_time
    5. 遇到异常时记录日志但不崩溃
    """
```

#### 6. 内容检查逻辑

```python
async def check_update(self, task: WebUpdateTask) -> Optional[str]:
    """
    检查网页是否更新
    
    流程:
    1. 使用httpx.AsyncClient获取网页
    2. 提取关键内容（可配置提取方式）
    3. 计算SHA256哈希值
    4. 与last_hash对比
    5. 返回新内容或None
    
    支持的提取方式:
    - 完整HTML
    - 网页标题
    - 特定CSS选择器内容
    """
```

### B. 配置文件设计

#### metadata.yaml
```yaml
name: webupdater
version: 1.0.0
display_name: 网页更新监控
description: 自动监控网页变化并推送更新提醒
author: You
homepage: https://github.com/yourname/astrbot_plugin_webupdater
repository: https://github.com/yourname/astrbot_plugin_webupdater
tags:
  - monitor
  - notification
  - web
```

#### plugin.yaml (配置模板)
```yaml
# 全局配置
global:
  # 网页请求超时时间（秒）
  http_timeout: 10
  
  # 网页获取失败重试次数
  max_retries: 3
  
  # 日志级别
  log_level: "INFO"
  
  # 是否在启动时自动启用所有任务
  auto_enable_on_startup: true
```

#### 存储格式 (data/webupdater/tasks.json)
```json
{
  "tasks": [
    {
      "id": "task_001",
      "url": "https://example.com/news",
      "interval": 300,
      "enabled": true,
      "last_hash": "abc123def456...",
      "last_check_time": 1700000000,
      "unified_msg_origin": "qguild:123:456",
      "created_time": 1699999999
    }
  ]
}
```

### C. requirements.txt
```
astrbot>=4.10.0
httpx>=0.24.0
```

---

## 使用流程示例

### 场景1: 监控GitHub仓库发布页
```
用户1: /webupdater add https://github.com/AstrBotDevs/AstrBot/releases 3600
机器人: ✅ 已添加监控任务 task_001，将每小时检查一次更新

[一段时间后，发布了新版本]
机器人: 📢 检测到网页更新！
      标题: AstrBot v4.11.0 Released
      URL: https://github.com/AstrBotDevs/AstrBot/releases
      更新时间: 2024-01-19 15:30:00
```

### 场景2: 管理多个监控任务
```
用户2: /webupdater list
机器人: 
  📋 当前监控任务列表:
  ━━━━━━━━━━━━━━━━━━━━━━━━━━
  ✅ task_001 (启用)
     URL: https://github.com/releases
     检查间隔: 1小时
     下次检查: 15:45
  
  ⏸️ task_002 (禁用)
     URL: https://blog.example.com
     检查间隔: 30分钟
     下次检查: 已禁用

用户2: /webupdater enable task_002
机器人: ✅ 已启用任务 task_002
```

---

## 关键技术实现细节

### 1. 异步架构
- 使用 `asyncio.create_task()` 创建后台监控任务
- 每个监控任务独立运行，互不阻塞
- 使用 `asyncio.sleep(interval)` 实现定时轮询

### 2. 内容变化检测
- **方法1**: SHA256哈希对比（推荐）
  - 完整内容哈希，精确检测任何变化
  - 快速比对，资源消耗低
  
- **方法2**: 版本号对比
  - 适用于HTML中包含版本号的场景
  - 示例: `<meta name="version" content="2.0.1">`

### 3. 数据持久化
- 任务配置存储在 `data/webupdater/tasks.json`
- 支持增量更新（仅保存变化部分）
- 启动时自动恢复所有任务

### 4. 错误处理
- 网络连接失败: 记录日志，等待下次检查
- 解析异常: 跳过该次检查，继续监控
- 任务崩溃: 单个任务异常不影响其他任务

### 5. 消息推送
- 使用 `context.send_message(unified_msg_origin, message_chain)` 主动推送
- 支持富媒体消息（文本+图片+链接）
- 推送时包含：URL、标题、摘要、时间戳

---

## 安全考虑

1. **URL验证**: 防止恶意URL（仅允许http/https协议）
2. **请求超时**: 防止网站无响应导致插件卡死
3. **内容过滤**: 防止不良内容推送
4. **权限控制**: 仅允许指定用户/群组管理监控任务（可扩展）
5. **资源限制**: 
   - 最多同时监控任务数限制
   - 单次请求数据大小限制
   - CPU/内存使用监控

---

## 扩展功能建议（v2.0+）

1. **内容提取选项**
   - CSS选择器提取特定元素
   - XPath表达式支持
   - 正则表达式提取

2. **通知选项**
   - 邮件推送集成
   - Discord/Telegram推送
   - Webhook自定义推送

3. **内容对比增强**
   - Diff展示修改内容
   - 图片变化检测（OCR）
   - 结构化数据对比

4. **定时任务框架**
   - 支持Cron表达式
   - 每日/每周定时触发
   - 事件触发条件

5. **数据统计**
   - 监控统计信息面板
   - 更新历史记录
   - 推送成功率统计

---

## 开发环境设置

### 1. 克隆模板和创建插件库
```bash
# 在GitHub上使用helloworld模板创建新仓库

# 克隆到AstrBot插件目录
cd AstrBot/data/plugins
git clone https://github.com/yourname/astrbot_plugin_webupdater
```

### 2. 项目初始化
```bash
# 进入插件目录
cd astrbot_plugin_webupdater

# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

### 3. 调试流程
- 修改代码后，在AstrBot WebUI插件管理中"重载插件"
- 查看插件日志输出验证功能
- 使用命令测试各项功能

---

## 测试计划

### 单元测试
- [ ] URL验证逻辑
- [ ] 哈希计算准确性
- [ ] 任务序列化/反序列化
- [ ] 指令参数解析

### 集成测试
- [ ] 添加监控 → 启动异步任务 → 检查更新
- [ ] 多任务并发监控
- [ ] 任务启用/禁用切换
- [ ] 插件热重载恢复

### 场景测试
- [ ] 网页内容无更新（应不推送）
- [ ] 网页下线（应处理异常）
- [ ] 长时间运行稳定性
- [ ] 大量任务同时监控

---

## 总结

这个插件设计充分利用了AstrBot的异步架构、灵活的事件系统和消息链机制，提供了一个强大的网页监控解决方案。通过模块化设计和清晰的错误处理，确保了插件的稳定性和可维护性。
