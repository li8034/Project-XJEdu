# 网页监控插件 - 系统架构与流程详解

## 系统整体架构

```
┌──────────────────────────────────────────────────────────┐
│                    用户界面层                              │
│   (QQ / 微信 / Discord / 企业应用 等消息平台)             │
└────────────────────────┬─────────────────────────────────┘
                         │
                         │ 消息事件下发
                         ▼
┌──────────────────────────────────────────────────────────┐
│                    AstrBot 核心框架                        │
│                                                            │
│  ┌────────────────┐    ┌──────────────┐                  │
│  │ 消息适配器      │    │ 插件加载器    │                  │
│  │ (Platform)     │    │ (Plugin      │                  │
│  │                │    │  Manager)    │                  │
│  └────────────────┘    └──────────────┘                  │
└────────────────────────┬─────────────────────────────────┘
                         │
                         │ 加载插件 / 下发事件
                         ▼
┌──────────────────────────────────────────────────────────┐
│         WebUpdaterPlugin (网页监控插件)                   │
│                                                            │
│  ┌─────────────────────────────────────────────────┐    │
│  │ 前端接口层 (User Interface)                      │    │
│  │                                                  │    │
│  │  指令处理:                                       │    │
│  │  /webupdater add <url> [interval]               │    │
│  │  /webupdater list                               │    │
│  │  /webupdater remove/enable/disable/check        │    │
│  └─────────────────────────────────────────────────┘    │
│           ▲              ▲              ▲                 │
│           │              │              │                 │
│  ┌────────┴──────┐ ┌─────┴────┐ ┌──────┴───────┐        │
│  │ 命令处理       │ │ 事件钩子  │ │ 时间触发器   │        │
│  │ (@command)    │ │ (@hook)   │ │ (asyncio)   │        │
│  └────────┬──────┘ └─────┬────┘ └──────┬───────┘        │
│           │              │             │                 │
│  ┌────────┴──────────────┴─────────────┴────────────┐   │
│  │        业务逻辑层 (Business Logic)                │   │
│  │                                                   │   │
│  │  ┌──────────────────────────────────────────┐   │   │
│  │  │ Task Management (任务管理)               │   │   │
│  │  │  - 创建/删除/启用/禁用任务              │   │   │
│  │  │  - 任务状态管理                         │   │   │
│  │  │  - 优先级控制                           │   │   │
│  │  └──────────────────────────────────────────┘   │   │
│  │                                                   │   │
│  │  ┌──────────────────────────────────────────┐   │   │
│  │  │ Monitoring Engine (监控引擎)             │   │   │
│  │  │  - 异步循环处理                         │   │   │
│  │  │  - 时间间隔控制                         │   │   │
│  │  │  - 超时处理与重试                       │   │   │
│  │  └──────────────────────────────────────────┘   │   │
│  │                                                   │   │
│  │  ┌──────────────────────────────────────────┐   │   │
│  │  │ Content Detection (内容检测)             │   │   │
│  │  │  - HTTP请求与获取                       │   │   │
│  │  │  - 哈希计算与对比                       │   │   │
│  │  │  - 内容摘要提取                         │   │   │
│  │  └──────────────────────────────────────────┘   │   │
│  │                                                   │   │
│  │  ┌──────────────────────────────────────────┐   │   │
│  │  │ Notification System (通知系统)           │   │   │
│  │  │  - 消息构建                             │   │   │
│  │  │  - 主动推送                             │   │   │
│  │  │  - 推送日志记录                         │   │   │
│  │  └──────────────────────────────────────────┘   │   │
│  │                                                   │   │
│  │  ┌──────────────────────────────────────────┐   │   │
│  │  │ Storage & Persistence (数据存储)         │   │   │
│  │  │  - JSON序列化/反序列化                   │   │   │
│  │  │  - 文件读写操作                         │   │   │
│  │  │  - 异常恢复                             │   │   │
│  │  └──────────────────────────────────────────┘   │   │
│  └───────────┬──────────────────────────────────────┘   │
│              │                                           │
│  ┌───────────┴──────────────────────────────────────┐   │
│  │      基础设施层 (Infrastructure)                  │   │
│  │                                                   │   │
│  │  ┌───────────┐  ┌────────────┐  ┌────────────┐  │   │
│  │  │  日志系统  │  │ 错误处理    │  │ 配置管理    │  │   │
│  │  │(logging)  │  │(exception) │  │(config)    │  │   │
│  │  └───────────┘  └────────────┘  └────────────┘  │   │
│  └───────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ▼               ▼               ▼
    ┌─────────┐    ┌──────────┐   ┌──────────┐
    │  网络层  │    │  存储层   │   │  日志层   │
    │(httpx)  │    │(JSON文件) │   │(文件)    │
    └─────────┘    └──────────┘   └──────────┘
         │               │               │
         ▼               ▼               ▼
    ┌──────────────┐ ┌────────────┐ ┌───────────┐
    │ 互联网        │ │ data/      │ │ logs/     │
    │ 网站         │ │ webupdater │ │ plugin    │
    │             │ │ /tasks.json │ │ .log     │
    └──────────────┘ └────────────┘ └───────────┘
```

---

## 指令处理流程

```
用户输入
  │
  │ /webupdater add https://example.com 300
  │
  ▼
AstrBot 消息适配器
  │
  │ 解析消息 & 识别命令
  │
  ▼
指令分发器 (@filter.command_group)
  │
  ├─ /webupdater add ──────┐
  │                        ▼
  ├─ /webupdater list      cmd_add_monitor(event, url, interval)
  │                        │
  ├─ /webupdater remove    │ ① 验证URL格式 (http/https)
  │                        │ ② 验证间隔值 (≥60)
  ├─ /webupdater enable    │
  │                        ▼
  ├─ /webupdater disable   创建 WebUpdateTask 对象
  │                        │
  └─ /webupdater check     │
                           ▼
                   保存到 self.tasks 字典
                           │
                           ▼
                   调用 save_tasks() 持久化
                           │
                           ▼
                   启动异步监控 (asyncio.create_task)
                           │
                           ▼
                   构建回复消息
                           │
                           ▼
                   yield event.plain_result()
                           │
                           ▼
                   消息返回给用户
```

---

## 监控任务生命周期

```
任务创建
  │
  │ /webupdater add <url> <interval>
  │
  ▼
CREATED (已创建)
  │
  ├─ 保存到存储 (tasks.json)
  │ 
  ▼
STARTED (已启动)
  │
  ├─ 创建异步协程
  ├─ 加入 running_tasks 字典
  │
  ▼
╔═════════════════════════════════╗
║ MONITORING (监控中) 循环         ║
║                                 ║
║  每隔 interval 秒:              ║
║  ① 获取网页内容                 ║
║  ② 计算SHA256哈希               ║
║  ③ 对比 last_hash              ║
║  ④ 如有更新则推送               ║
║  ⑤ 等待下一个周期               ║
╚═════════════════════════════════╝
  │
  ├─ /webupdater disable ──┐
  │                        ▼
  ├─ /webupdater enable    DISABLED (已禁用)
  │                        │ ┌────────────┐
  ├─ /webupdater remove ──┐│ │ 可重新启用  │
  │                       ││ └────────────┘
  │                       ▼│
  ▼                       STOPPING (停止中)
STOPPED (已停止)           │
  │                       ▼
  │                    ✓ 取消异步任务
  │                    ✓ 清理资源
  │
  ├─ 从 running_tasks 中移除
  ├─ 保存最后状态
  │
  ▼
FINISHED (已完成)
  │
  └─ 任务可被重新启动或删除
```

---

## 监控循环执行流程

```
┌─────────────────────────────────────┐
│  async def _monitoring_loop()       │
│  for task_id in running_tasks       │
└─────────────────────────────────────┘
           │
           ▼
    ┌──────────────┐
    │ 检查启用状态  │
    └──────┬───────┘
           │
       enabled? ──NO─→ await sleep(10s) ──┐
           │ YES                          │
           ▼                              │
   ┌───────────────────┐                  │
   │ await check_      │                  │
   │ update(task)      │                  │
   └─────────┬─────────┘                  │
             │                            │
         content ──NO─→ 无更新 ──────┐   │
             │ YES                  │   │
             ▼                      │   │
      ┌─────────────┐              │   │
      │ await send_ │              │   │
      │ update_     │              │   │
      │ notification│              │   │
      └─────────────┘              │   │
             │                      │   │
             ▼                      ▼   ▼
      ┌──────────────────────┐
      │ await asyncio.sleep  │
      │ (task.interval)      │
      └──────────┬───────────┘
                 │
             ┌───┴──────────────┐
             │ 异常处理         │
             │                  │
             NO ◄─ CancelledError?
             │
             YES ▼
             │ break (退出循环)
             │
             NO ◄─ 其他异常?
             │
             YES ▼
             │ logger.error()
             │ await sleep(60s)
             │
             └─→ 继续循环
```

---

## 内容检测对比流程

```
┌─────────────────────────────┐
│ async check_update()        │
└──────────────┬──────────────┘
               │
               ▼
    ┌────────────────────────┐
    │ await _fetch_url(url)  │
    │ (httpx.AsyncClient)    │
    └────────┬───────────────┘
             │
         ┌───┴────────────────────────────┐
         │                                │
       成功                              失败
       (200)                            (其他)
         │                                │
         ▼                                ▼
    获取 content                    logger.warning()
         │                                │
         ▼                                ├─ 重试机制
    计算哈希值                          │  (max_retries)
    sha256(content)                      │
         │                                ├─ 超时处理
         ▼                                │
    ┌─────────────────┐                  ├─ 异常捕获
    │ 对比 last_hash  │                  │
    └────┬────────────┘                  ▼
         │                          返回 None
         ▼
    ┌──────────────┐
    ├─ 完全相同 ──NO─→ 更新记录
    │  return None           │
    └────┬────────           ▼
      YES │          task.last_hash = new_hash
         │           task.last_check_time = now
         │           save_tasks()
         │                  │
         │                  ▼
         │          提取内容摘要
         │          _extract_content_summary()
         │                  │
         │                  ▼
         │          返回摘要信息
         │                  │
         ▼                  ▼
      return None      return summary
```

---

## 消息推送流程

```
┌────────────────────────────────┐
│ async _send_update_             │
│ notification()                  │
└──────────────┬─────────────────┘
               │
               ▼
    ┌──────────────────────┐
    │ 构建消息链            │
    │ (MessageChain)        │
    │                       │
    │ - Title/URL           │
    │ - Content Summary     │
    │ - Timestamp           │
    │ - [Images/Links]      │
    └──────────┬────────────┘
               │
               ▼
    ┌──────────────────────────────┐
    │ await context.send_message() │
    │  unified_msg_origin          │
    │  message_chain               │
    └──────────┬───────────────────┘
               │
           ┌───┴────────────────┐
           │                    │
         成功                   失败
         (推送)                (异常)
           │                    │
           ▼                    ▼
    ┌────────────────┐    ┌──────────────┐
    │ logger.info()  │    │ logger.error()│
    │ "推送成功"      │    │ "推送失败"     │
    └────────────────┘    └──────────────┘
           │                    │
           ▼                    ▼
        返回              继续监控
       (推送结束)         (不中断任务)
```

---

## 数据存储结构

```
AstrBot/
└── data/
    └── webupdater/
        └── tasks.json (JSON格式存储)

{
  "tasks": [
    {
      "id": "abc12345",
      "url": "https://github.com/releases",
      "interval": 3600,              ┌─ 检查间隔(秒)
      "enabled": true,               ├─ 是否启用
      "unified_msg_origin": "...",   ├─ 推送目标
      "last_hash": "e3b0c44298...",  ├─ 上次哈希值
      "last_check_time": 1705675800, ├─ 上次检查时间戳
      "created_time": 1705672200     └─ 创建时间戳
    },
    ...
  ]
}

键值说明:
├─ id: 任务唯一标识符(8位UUID)
├─ url: 要监控的网页URL
├─ interval: 检查间隔(最小60秒)
├─ enabled: boolean值，控制任务是否运行
├─ unified_msg_origin: 会话标识(用于消息推送)
├─ last_hash: SHA256哈希值(64字符十六进制)
├─ last_check_time: Unix时间戳(整数)
└─ created_time: Unix时间戳(整数)
```

---

## 错误处理与恢复

```
异常发生
  │
  ├─ HTTPException (网络异常)
  │  │
  │  ├─ Timeout ──→ 重试 (max_retries)
  │  │
  │  └─ 其他异常 ──→ logger.error() + 等待60秒
  │
  ├─ JSON异常 (存储异常)
  │  │
  │  └─ 保存失败 ──→ logger.error() + 数据仍在内存
  │
  ├─ CancelledError (取消)
  │  │
  │  └─ 正常退出 ──→ 清理资源
  │
  └─ 其他异常
     │
     └─ 记录日志 + 继续运行

关键原则:
┌─────────────────────────────────┐
│ 单个任务异常 ≠ 全局崩溃        │
│ 单个网站超时 ≠ 监控中止         │
│ 存储失败     ≠ 监控停止         │
└─────────────────────────────────┘
```

---

## 性能监控指标

```
┌────────────────────────────────────┐
│        性能指标收集               │
└────────────────────────────────────┘
              │
    ┌─────────┼─────────┐
    │         │         │
    ▼         ▼         ▼
  CPU    内存占用   网络I/O
  占用    增长      流量
  │         │         │
  ▼         ▼         ▼
  监控   每任务    每次请求
  总数   ~5-10MB   ~1-5KB
  │         │         │
  └─────────┼─────────┘
            │
            ▼
    性能优化建议:
    ├─ 减少监控数量
    ├─ 增加检查间隔
    ├─ 使用内容摘要
    └─ 定期清理历史
```

---

## 启动与恢复流程

```
AstrBot 启动
  │
  ▼
┌──────────────────────┐
│ on_astrbot_loaded()  │
│ 事件钩子触发         │
└──────────┬───────────┘
           │
           ▼
    ┌────────────────┐
    │ load_tasks()   │
    │ 从JSON读取     │
    └──────┬─────────┘
           │
           ├─ 文件存在 ──→ 解析JSON
           │ 文件不存在 ──→ 返回空列表
           │
           ▼
    ┌──────────────────────┐
    │ 遍历所有保存的任务    │
    └──────┬───────────────┘
           │
        enabled?
           │
       ┌───┴───┐
      YES      NO
       │        └─→ 跳过(已禁用)
       │
       ▼
    ┌──────────────────────┐
    │ 启动异步监控         │
    │ start_monitoring()   │
    └──────┬───────────────┘
           │
           ▼
    ┌──────────────────────────┐
    │ asyncio.create_task()    │
    │ _monitoring_loop(id)     │
    └──────┬───────────────────┘
           │
           ├─ Task成功创建
           ├─ 添加到 running_tasks
           │
           ▼
    ┌────────────────────┐
    │ logger.info()      │
    │ "已启动监控任务"    │
    └────────────────────┘
           │
           ▼
    所有任务已启动
    系统准备就绪
```

---

## 状态转移图

```
                                 ┌──────────────┐
                            ┌───→│  CREATED     │◄────┐
                            │    │  (已创建)     │     │
                            │    └──────────────┘     │
                            │                        │
                /webupdater │                        │ /webupdater
                add         │                        │ enable
                            │                        │
                ┌───────────┴────────────┐          │
                │                        │          │
                ▼                        ▼          │
        ┌──────────────┐         ┌──────────────┐  │
        │ DISABLED     │         │  MONITORING  │  │
        │ (已禁用)     │◄────────│  (监控中)    │  │
        │              │ disable │              │  │
        └──────────────┘         └──────────────┘  │
                │                        ▲          │
                │                        │          │
                │                        │          │
        remove  │                        │          │
                │                    enable         │
                ▼                        │          │
        ┌──────────────┐                 │          │
        │  DELETED     │─────────────────┴──────────┘
        │  (已删除)     │        (可恢复)
        └──────────────┘

状态说明:
CREATED:   新创建的任务，但未启动监控
MONITORING: 正在积极监控的任务
DISABLED:   已禁用，不进行监控但仍保存
DELETED:    已删除的任务
```

---

## 总结

这个架构设计实现了：

✅ **高效异步处理** - 多任务并发不阻塞
✅ **可靠错误恢复** - 单点失败不影响全局
✅ **数据持久化** - 重启自动恢复
✅ **灵活任务管理** - 生命周期完整控制
✅ **实时内容检测** - 哈希对比精确识别
✅ **主动消息推送** - 事件驱动通知用户

通过模块化设计和分层架构，确保了系统的稳定性、可扩展性和可维护性。
